/*
 * Tuppari JavaScript Library v0.1.0
 *
 * Copyright 2012, Tuppari.com
 * Released under the MIT licence.
 */(function(e){function r(){}function i(e,t){var n=this;n.applicationId=e,n.url=t,n.ws=null,n.connected=!1,n.healthcheckInterval=2e4,n.healthcheckTimer=null,n.on("open",function(e){n.connected=!0,n.ws=e,n.emit("connect")}),n.on("close",function(e){n.connected=!1,n.ws&&n.ws.close(),n.ws=null,n.emit("disconnect",e)})}function s(e,t){this.client=e,this.name=t,this.events={}}function o(e){var t=this;t.applicationId=e.applicationId,t.url=e.url||"http://ws.tuppari.com",t.connected=!1,t.channels={},t.socket=new i(t.applicationId,t.url),t.firstConnect=!0,t.socket.on("connect",function(){t.emit("log","connected");if(t.firstConnect)t.firstConnect=!1;else{var e=t.channels,n,r;for(n in e)e.hasOwnProperty(n)&&(r=e[n],r._rebind())}}),t.socket.on("disconnect",function(e){t.emit("log","disconnected",e)}),t.socket.on("message",function(e,n,r){var i=t.channels[e];i&&i.emit(n,r)}),t.socket.on("send",function(e,n,r){t.emit("log","send",e,n,r)}),t.socket.on("error",function(e){t.emit("error",e)}),t.connect()}function a(e,t){function n(){}n.prototype=t.prototype,e.prototype=new n}function f(e,t){var n=new XMLHttpRequest;n.onload=function(e){t(null,n)},n.onerror=function(){t(new Error("Connect failed to "+e))},n.open("GET",e,!0),n.send()}function l(e){return new o(e)}var t="subscribe",n="bind";r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(e){this._events||(this._events={}),this._maxListeners=e},r.prototype.emit=function(){var e=arguments[0];if(e==="error")if(!this._events||!this._events.error||u(this._events.error)&&!this._events.error.length)throw arguments[1]instanceof Error?arguments[1]:new Error("Uncaught, unspecified 'error' event.");if(!this._events)return!1;var t=this._events[e];if(!t)return!1;if(typeof t=="function"){switch(arguments.length){case 1:t.call(this);break;case 2:t.call(this,arguments[1]);break;case 3:t.call(this,arguments[1],arguments[2]);break;default:var n=arguments.length,r=new Array(n-1);for(var i=1;i<n;i++)r[i-1]=arguments[i];t.apply(this,r)}return!0}if(u(t)){var n=arguments.length,r=new Array(n-1);for(var i=1;i<n;i++)r[i-1]=arguments[i];var s=t.slice();for(var i=0,n=s.length;i<n;i++)s[i].apply(this,r);return!0}return!1},r.prototype.addListener=function(e,t){if("function"!=typeof t)throw new Error("addListener only takes instances of Function");this._events||(this._events={}),this.emit("newListener",e,typeof t.listener=="function"?t.listener:t),this._events[e]?u(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t;if(u(this._events[e])&&!this._events[e].warned){var n;this._maxListeners!==undefined?n=this._maxListeners:n=r.defaultMaxListeners,n&&n>0&&this._events[e].length>n&&(this._events[e].warned=!0)}return this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(e,t){function r(){n.removeListener(e,r),t.apply(this,arguments)}if("function"!=typeof t)throw new Error(".once only takes instances of Function");var n=this;return r.listener=t,n.on(e,r),this},r.prototype.removeListener=function(e,t){if("function"!=typeof t)throw new Error("removeListener only takes instances of Function");if(!this._events||!this._events[e])return this;var n=this._events[e];if(u(n)){var r=-1;for(var i=0,s=n.length;i<s;i++)if(n[i]===t||n[i].listener&&n[i].listener===t){r=i;break}if(r<0)return this;n.splice(r,1)}else(n===t||n.listener&&n.listener===t)&&delete this._events[e];return this},r.prototype.removeAllListeners=function(e){if(arguments.length===0)return this._events={},this;var t=this._events&&this._events[e];return t?(u(t)?t.splice(0):this._events[e]=null,this):this},r.prototype.listeners=function(e){return this._events||(this._events={}),this._events[e]||(this._events[e]=[]),u(this._events[e])||(this._events[e]=[this._events[e]]),this._events[e]},a(i,r),i.prototype.open=function(){var e=this;e.close(),e.healthcheckTimer=setInterval(function(){(e.ws===null||e.ws.readyState>1)&&e.open()},e.healthcheckInterval),e._open()},i.prototype._open=function(){var e=this;f(e.url+"/endpoint",function(t,n){if(t)return e.emit("error",t);var r=n.responseText;if(!r)return e.emit("error","WebSocket endpoint URL not found");var i=new WebSocket(r);i.onopen=function(){e.emit("open",i)},i.onclose=function(t){e.emit("close",t)},i.onmessage=function(t){try{var n=JSON.parse(t.data);if(n.room){var r=n.room.split(":");r.length===3&&r[0]===e.applicationId&&e.emit("message",r[1],r[2],n.message)}}catch(i){e.emit("error",i)}},i.onerror=function(t){e.emit("error",t)}})},i.prototype.send=function(e,t){function i(){if(n.ws){var e=n.ws.send(JSON.stringify(r));n.emit("send",e,n.ws,r)}else setTimeout(i,100)}var n=this,r={};r.applicationId=n.applicationId,r.event=e,r.data=t,i()},i.prototype.close=function(){this.connected=!1,this.healthcheckTimer&&(clearInterval(this.healthcheckTimer),this.healthcheckTimer=null),this.ws&&(this.ws.close(),this.ws=null)},s.prototype.bind=function(e,t){this.events[e]=t,this.client.bind(this.name,e)},s.prototype.emit=function(e,t){var n=this.events[e];n&&n(t)},s.prototype._rebind=function(){var e=this.events,t;for(t in e)e.hasOwnProperty(t)&&this.client.bind(this.name,t)},a(o,r),o.prototype.subscribe=function(e){var t=new s(this,e);return this.channels[e]=t,t},o.prototype.bind=function(e,t){var r={channelName:e,eventName:t};this.socket.send(n,r)},o.prototype.connect=function(){this.socket.open()},o.prototype.disconnect=function(){this.socket.close()};var u=Array.isArray||function(e){return Object.prototype.toString.call(e)==="[object Array]"};e.tuppari={createClient:l,Client:o,Channel:s}})(this);